# Copyright (c) 2017-present SIGHUP s.r.l All rights reserved.
# Use of this source code is governed by a BSD-style
# license that can be found in the LICENSE file.

[env]
# Default values for local development
KUBE_VERSION = "1.33.0"
DRONE_BUILD_NUMBER = "9999"
DRONE_REPO_NAME = "module-auth"

[tools]
kind = "0.29.0"    
kubectl = "1.33.4" 
kustomize = "5.6.0"
helm = "3.15.0"    
yq = "4.43.1"      
go = "1.23"        
bats = "1.11.0"    
drone = "1.9.0"
kapp = "0.64.2"
"ubi:google/addlicense" = "v1.1.1"

# Development task definitions
[tasks.add-license]
description = "Add license headers to all files"
run = '''
echo "📄 Adding license headers..."
addlicense -c "SIGHUP s.r.l" -y "2017-present" -v -l bsd .
echo "✅ License headers added!"
'''

[tasks.validate-manifests]
description = "Validate all manifests can be built"
run = '''
echo "🔍 Validating manifest builds..."
kustomize build katalog/tests/manifests/pomerium > /dev/null && echo "  ✅ pomerium"
kustomize build katalog/tests/manifests/dex > /dev/null && echo "  ✅ dex"
kustomize build katalog/tests/manifests/gangplank > /dev/null && echo "  ✅ gangplank"
kustomize build katalog/tests/manifests > /dev/null && echo "  ✅ complete auth stack"
echo "✅ All manifests validated!"
'''

[tasks.setup]
description = "Complete development environment setup"
run = '''
echo "🚀 Setting up development environment..."
mise run add-license
mise run validate-manifests
echo "✅ Development environment ready!"
'''

[tasks.e2e]
description = "Run complete E2E test suite with Kind cluster"
run = "./scripts/run-e2e-tests.sh"

[tasks.e2e-cleanup]
description = "Clean up any leftover Kind clusters from E2E tests"
run = '''
echo "🧹 Cleaning up E2E test clusters..."
for cluster in $(kind get clusters | grep module-auth); do
  echo "  Deleting cluster: $cluster"
  kind delete cluster --name "$cluster"
done
echo "✅ Cleanup complete!"
'''

[tasks.process-templates]
description = "Process all template files with environment variables"
run = "./scripts/process-templates.sh"

[tasks.clean-generated]
description = "Remove all generated files for a fresh start"
run = "./scripts/clean-generated.sh"

[tasks.test-local]
description = "Quick local testing without full e2e cluster setup"
run = '''
echo "🧪 Running local validation tests..."

# Validate templates can be processed
export MACHINE_IP_NIP_DOMAIN="${MACHINE_IP_NIP_DOMAIN:-127.0.0.1.nip.io}"
export EXTERNAL_PORT="${EXTERNAL_PORT:-443}"

echo "  → Processing templates..."
mise run process-templates

echo "  → Validating manifests..."
mise run validate-manifests

echo "  → Cleaning up..."
mise run clean-generated

echo "✅ Local tests passed!"
'''