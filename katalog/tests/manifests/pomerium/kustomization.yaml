# Copyright (c) 2017-present SIGHUP s.r.l All rights reserved.
# Use of this source code is governed by a BSD-style
# license that can be found in the LICENSE file.

apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

resources:
  - ../../../pomerium

configMapGenerator:
  - name: pomerium
    behavior: replace
    envs:
      - resources/pomerium-config.env
  - name: pomerium-policy
    behavior: replace
    files:
      - policy.yml=resources/pomerium-policy.yml

secretGenerator:
  - name: pomerium-env
    behavior: replace
    envs:
      - secrets/pomerium.env

# Patches
patches:
  - target:
      kind: Ingress
      name: pomerium
    patch: |-
      - op: replace
        path: /spec/ingressClassName
        value: nginx
  
  - target:
      kind: Deployment
      name: pomerium
    patch: |-
      - op: add
        path: /spec/template/spec/containers/0/volumeMounts/-
        value:
          name: ca-cert
          mountPath: /certs
          readOnly: true
      - op: add
        path: /spec/template/spec/volumes/-
        value:
          name: ca-cert
          secret:
            secretName: pomerium-tls
            items:
            - key: ca.crt
              path: ca.crt
      - op: add
        path: /spec/template/spec/hostNetwork
        value: true
      - op: add
        path: /spec/template/spec/dnsPolicy
        value: ClusterFirstWithHostNet